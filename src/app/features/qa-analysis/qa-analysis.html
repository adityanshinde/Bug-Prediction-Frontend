<div class="qa-analysis-page">

  @if (noProjectSelected()) {
    <div class="no-project-banner">
      <i class="fas fa-info-circle"></i>
      Please select a project from the <strong>Projects</strong> page first.
    </div>
  }

  <div class="qa-grid">
    <!-- Manual QA Entry Form -->
    <div class="qa-form-card">
      <h2 class="section-title">Manual QA Entry</h2>

      @if (submitSuccess()) {
        <div class="success-banner">
          <i class="fas fa-check-circle"></i> Entry submitted successfully!
        </div>
      }

      <form class="qa-form" [formGroup]="qaForm" (ngSubmit)="onSubmit()">
        <div class="form-group">
          <label>Module *</label>
          <select class="form-control" formControlName="module">
            <option value="">Select module</option>
            @if (moduleOptions().length === 0) {
              <option disabled>Select a project first to load modules</option>
            }
            @for (mod of moduleOptions(); track mod) {
              <option [value]="mod">{{ mod }}</option>
            }
          </select>
          @if (formSubmitted() && qaForm.get('module')?.invalid) {
            <div class="error-message">{{ getErrorMessage('module') }}</div>
          }
        </div>

        <div class="form-group">
          <label>Issue Type *</label>
          <select class="form-control" formControlName="issueType">
            <option value="">Select issue type</option>
            @for (type of issueTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
          @if (formSubmitted() && qaForm.get('issueType')?.invalid) {
            <div class="error-message">{{ getErrorMessage('issueType') }}</div>
          }
        </div>

        <div class="form-group">
          <label>Severity *</label>
          <select class="form-control" formControlName="severity">
            <option value="">Select severity</option>
            @for (severity of severityLevels; track severity) {
              <option [value]="severity">{{ severity }}</option>
            }
          </select>
          @if (formSubmitted() && qaForm.get('severity')?.invalid) {
            <div class="error-message">{{ getErrorMessage('severity') }}</div>
          }
        </div>

        <div class="form-group">
          <label>Description</label>
          <textarea class="form-control" rows="4" formControlName="description"
            placeholder="Enter issue description (optional, minimum 10 characters if provided)..."></textarea>
          @if (formSubmitted() && qaForm.get('description')?.invalid) {
            <div class="error-message">{{ getErrorMessage('description') }}</div>
          }
        </div>

        <div class="form-group">
          <label>Reported By</label>
          <input type="text" class="form-control" formControlName="reportedBy" placeholder="Your name (optional)" />
        </div>

        <button type="submit" class="btn btn-primary" [disabled]="isSubmitting()">
          @if (isSubmitting()) { Submitting... } @else { Submit Entry }
        </button>
      </form>
    </div>

    <!-- QA Summary and Entries -->
    <div class="qa-results">
      <!-- QA Summary KPIs -->
      <h2 class="section-title">QA Summary</h2>

      @if (isLoading()) {
        <app-loader message="Loading QA data..." />
      } @else if (error()) {
        <app-error-state [message]="error()!" (retry)="reload()" />
      } @else {
        <div class="qa-summary-grid">
          @for (item of qaSummary(); track item.label) {
            <div class="qa-summary-card" [class]="item.color">
              <div class="summary-icon">{{ item.icon }}</div>
              <div class="summary-value">{{ item.value }}</div>
              <div class="summary-label">{{ item.label }}</div>
            </div>
          }
        </div>

        <!-- Comparison: Manual vs Automated -->
        <h2 class="section-title mt-4">Manual vs Automated Comparison</h2>

        @if (entries().length === 0) {
          <div class="empty-entries">
            <i class="fas fa-inbox"></i>
            <p>No entries submitted yet. Use the form to add your first QA entry.</p>
          </div>
        } @else {
          <!-- Comparison summary bar -->
          <div class="comparison-stats-bar">
            <span class="cstat matched">
              <i class="fas fa-check-circle"></i>
              Matched by Automation: <strong>{{ matchedCount() }}</strong>
            </span>
            <span class="cstat manual-only">
              <i class="fas fa-exclamation-circle"></i>
              Manual Only (not in scan): <strong>{{ manualOnlyCount() }}</strong>
            </span>
          </div>

          <table class="comparison-table">
            <thead>
              <tr>
                <th>Module</th>
                <th>Type</th>
                <th>Severity</th>
                <th>Description</th>
                <th>Reported By</th>
                <th>Automated Found</th>
                <th>Result</th>
              </tr>
            </thead>
            <tbody>
              @for (row of comparisonData(); track row.id) {
                <tr [class.row-matched]="row.result === 'Matched'" [class.row-manual-only]="row.result === 'Manual Only'">
                  <td>{{ row.moduleName }}</td>
                  <td>
                    <span class="badge"
                      [class.badge-danger]="row.issueType === 'Bug'"
                      [class.badge-warning]="row.issueType === 'Vulnerability'"
                      [class.badge-success]="row.issueType === 'Code Smell'">
                      {{ row.issueType }}
                    </span>
                  </td>
                  <td>
                    <span class="badge"
                      [class.badge-danger]="row.severity === 'Critical' || row.severity === 'High'"
                      [class.badge-warning]="row.severity === 'Medium'"
                      [class.badge-success]="row.severity === 'Low'">
                      {{ row.severity }}
                    </span>
                  </td>
                  <td>{{ row.description ?? '—' }}</td>
                  <td>{{ row.reportedBy ?? '—' }}</td>
                  <td class="automated-count">
                    @if (row.automatedCount > 0) {
                      <span class="auto-found"><i class="fas fa-robot"></i> {{ row.automatedCount }} issue{{ row.automatedCount > 1 ? 's' : '' }}</span>
                    } @else {
                      <span class="auto-not-found"><i class="fas fa-minus-circle"></i> Not detected</span>
                    }
                  </td>
                  <td>
                    <span class="badge"
                      [class.badge-success]="row.result === 'Matched'"
                      [class.badge-warning]="row.result === 'Manual Only'">
                      {{ row.result }}
                    </span>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        }
      }
    </div>
  </div>
</div>
