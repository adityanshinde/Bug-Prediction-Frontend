<div class="risk-analysis-page">
  @if (noProjectSelected()) {
    <div class="no-project-banner">
      <i class="fas fa-info-circle"></i>
      Please select a project from the <strong>Projects</strong> page first.
    </div>
  }

  @if (isLoading()) {
    <app-loader message="Loading risk analysis..." />
  } @else if (error()) {
    <app-error-state [message]="error()!" (retry)="reload()" />
  } @else if (data()) {

  <!-- Top Section: Overall Risk & Chart -->
  <div class="top-section">
    <!-- Overall Risk Card -->
    <div class="overall-risk-card">
      <h2 class="section-title">Overall Risk</h2>
      <div class="risk-display">
        <div class="risk-top">
          <div class="risk-icon">
            <i class="fas fa-exclamation-triangle"></i>
          </div>
          <div class="risk-value">
            <span class="risk-number">{{ overallRisk().score }}</span>
            <span class="risk-text">{{ overallRisk().level }}</span>
          </div>
        </div>
        <div class="risk-bottom">
          <div class="risk-label">Risk Score</div>
          <div class="risk-status">{{ overallRisk().status }}</div>
        </div>
      </div>
    </div>

    <!-- Module Risk Distribution -->
    <div class="risk-chart-card">
      <h2 class="section-title">Module Risk Distribution</h2>
      <div class="chart-container">
        <svg width="100%" height="300" viewBox="0 0 700 300" class="bar-chart" preserveAspectRatio="xMidYMid meet">
          <!-- Y-axis labels -->
          <text x="20" y="25" text-anchor="end" fill="#64748B" font-size="12">100</text>
          <text x="20" y="85" text-anchor="end" fill="#64748B" font-size="12">75</text>
          <text x="20" y="145" text-anchor="end" fill="#64748B" font-size="12">50</text>
          <text x="20" y="205" text-anchor="end" fill="#64748B" font-size="12">25</text>
          <text x="20" y="260" text-anchor="end" fill="#64748B" font-size="12">0</text>
          <!-- Grid lines -->
          <line x1="35" y1="20" x2="680" y2="20" stroke="#E5E7EB" stroke-width="1"/>
          <line x1="35" y1="80" x2="680" y2="80" stroke="#E5E7EB" stroke-width="1"/>
          <line x1="35" y1="140" x2="680" y2="140" stroke="#E5E7EB" stroke-width="1"/>
          <line x1="35" y1="200" x2="680" y2="200" stroke="#E5E7EB" stroke-width="1"/>
          <line x1="35" y1="260" x2="680" y2="260" stroke="#E5E7EB" stroke-width="2"/>
          <!-- Bars -->
          <g transform="translate(35, 0)">
            @for (module of moduleRiskChart(); track module.name; let i = $index) {
              <rect [attr.x]="40 + (i * 100)" [attr.y]="module.y" width="70" [attr.height]="module.height" fill="#DC2626" rx="2"/>
            }
            @for (module of moduleRiskChart(); track module.name; let i = $index) {
              <text [attr.x]="75 + (i * 100)" y="285" text-anchor="middle" fill="#1f2937" font-size="11" font-weight="500">{{ module.name }}</text>
            }
          </g>
        </svg>
      </div>
    </div>
  </div>

  <!-- High-Risk Modules Table -->
  <div class="risk-table-card">
    <h2 class="section-title">High-Risk Modules</h2>
    <div class="table-wrapper">
      <table class="risk-table">
        <thead>
          <tr>
            <th>Module Name</th>
            <th>Bugs</th>
            <th>Vulnerabilities</th>
            <th>Coverage %</th>
            <th>Duplication %</th>
            <th>Risk Score</th>
            <th>Risk Level</th>
          </tr>
        </thead>
        <tbody>
          @if (computedModules().length === 0) {
            <tr>
              <td colspan="7" class="empty-state">
                <div class="empty-state-content">
                  <i class="fas fa-check-circle"></i>
                  <p>No high-risk modules detected!</p>
                  <small>All modules are within acceptable risk levels</small>
                </div>
              </td>
            </tr>
          } @else {
            @for (module of pagedModules(); track module.moduleName) {
              <tr>
                <td><strong>{{ module.moduleName }}</strong></td>
                <td>{{ module.bugs }}</td>
                <td>{{ module.vulnerabilities }}</td>
                <td>{{ module.coverage }}%</td>
                <td>{{ module.duplication }}%</td>
                <td><strong>{{ module.riskScore }}</strong></td>
                <td>
                  <span class="badge"
                    [class.badge-danger]="module.riskLevel === 'HIGH'"
                    [class.badge-warning]="module.riskLevel === 'MEDIUM'">
                    {{ module.riskLevel }}
                  </span>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>

    @if (totalPages() > 1) {
      <div class="pagination-bar">
        <span class="page-info">
          Showing {{ pageStart() }}–{{ pageEnd() }} of {{ computedModules().length }} modules
        </span>
        <div class="page-controls">
          <button class="page-btn" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">
            <i class="fas fa-chevron-left"></i>
          </button>
          @for (item of pageItems(); track $index) {
            @if (item === null) {
              <span class="page-ellipsis">…</span>
            } @else {
              <button class="page-btn" [class.active]="item === currentPage()" (click)="goToPage(item)">{{ item }}</button>
            }
          }
          <button class="page-btn" [disabled]="currentPage() === totalPages()" (click)="goToPage(currentPage() + 1)">
            <i class="fas fa-chevron-right"></i>
          </button>
        </div>
      </div>
    }
  </div>

  } <!-- end @else if (data()) -->
</div>
